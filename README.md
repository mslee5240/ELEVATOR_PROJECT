# STM32 엘리베이터 제어 시스템

STM32F411과 FreeRTOS를 활용한 완전한 4층 엘리베이터 제어 시스템입니다.

## 🚀 주요 기능

- **4층 제어**: 스텝모터를 이용한 실제 엘리베이터 시뮬레이션
- **다중 디스플레이**: 도트매트릭스(층수/방향), FND(상태), LCD(시간)
- **음향 피드백**: PWM 부저로 도착음 및 층 선택음 제공
- **실시간 시계**: DS1302 RTC와 플래시 메모리 백업
- **멀티태스킹**: FreeRTOS 기반 5개 태스크 동시 실행

## 🛠️ 필요 하드웨어

- **마이크로컨트롤러**: STM32F411CEU6
- **모터**: 2상 스텝모터
- **센서**: 포토센서 4개 (층 감지용)
- **디스플레이**: 8x8 도트매트릭스, 4자리 FND, I2C LCD
- **음향**: PWM 부저
- **시계**: DS1302 실시간 시계 모듈
- **입력**: 푸시버튼 4개 (층 선택용)

## 📋 핀 구성

| 구성요소 | 핀 번호 | 설명 |
|----------|---------|------|
| 스텝모터 | PC6-PC9 | IN1-IN4 제어 신호 |
| 포토센서 | PB0-PB3 | 층 감지 (1-4층) |
| 층선택버튼 | PC0-PC3 | 층 선택 (1-4층) |
| 도트매트릭스 | PB10,13,15 | SPI 인터페이스 |
| FND 디스플레이 | PC10-PC12 | SPI 인터페이스 |
| I2C LCD | PB8-PB9 | 소프트웨어 I2C |
| 부저 | PA6 | PWM 출력 |
| DS1302 RTC | PA4-PA7 | 3-wire 시리얼 |

## 💻 소프트웨어 구조

### FreeRTOS 태스크
- **태스크 1** (보통): 엘리베이터 메인 제어
- **태스크 2** (낮음): RTC 시간 표시
- **태스크 3** (낮음): 도트매트릭스 제어
- **태스크 4** (낮음): 부저 음향 제어
- **태스크 5** (낮음): FND 디스플레이 (비활성화)

### 상태 머신
```
IDLE     → 층수 표시 (1-4)
FORWARD  → 상승 화살표 애니메이션
BACKWARD → 하강 화살표 애니메이션
```

## 🔧 빌드 및 플래시

1. **준비사항**
   - STM32CubeIDE
   - STM32F4xx HAL 드라이버
   - FreeRTOS

2. **빌드**
   ```bash
   # STM32CubeIDE에서 프로젝트 열기
   # 빌드: Ctrl+B
   ```

3. **플래시**
   ```bash
   # ST-Link를 통한 플래시
   # 디버그: F11
   ```

## 🎮 사용법

### 기본 조작
1. 층 선택 버튼(1-4) 눌러 목적지 선택
2. 엘리베이터가 자동으로 목표 층으로 이동
3. 목적지 도착 시 도착음 재생
4. 도트매트릭스에 현재 층 표시

### UART 명령어
UART 연결(9600 bps):
```
setrtc[YYMMDDHHMMSS] - RTC 시간 설정
print_rtc            - RTC 출력 활성화
printoff_rtc         - RTC 출력 비활성화
help                 - 명령어 도움말
```

## 📊 기술 사양

- **모터 속도**: 13 RPM (최적화됨)
- **응답 시간**: 30ms 이하 (버튼에서 모터까지)
- **위치 정확도**: ±0.1층
- **음향 지연**: 10ms 이하
- **디스플레이 갱신**: 1ms-500ms (구성요소별)

## 📁 프로젝트 구조

```
├── Core/
│   ├── Src/
│   │   ├── main.c           # 시스템 초기화
│   │   ├── stepmotor.c      # 모터 제어
│   │   ├── button.c         # 입력 처리
│   │   ├── dotmatrix.c      # 디스플레이 제어
│   │   ├── buzzer.c         # 음향 시스템
│   │   ├── ds1302.c         # RTC 관리
│   │   ├── i2c_lcd.c        # LCD 인터페이스
│   │   └── ...
│   └── Inc/                 # 헤더 파일
├── Drivers/                 # HAL 드라이버
└── Middlewares/             # FreeRTOS
```

## 🎯 핵심 기능 상세

### 모터 제어
- 2상 스텝모터 구동
- 부드러운 동작을 위한 8단계 시퀀스
- 가변 RPM 제어 (1-13 RPM)

### 위치 피드백
- 정확한 층 감지를 위한 포토센서 인터럽트
- 목표 층 도달 시 자동 정지
- 실시간 위치 추적

### 음향 시스템
- 엘리베이터 도착 멜로디 (A5-A5-G5-Gb5)
- 층 선택 확인 비프음
- PWM 기반 톤 생성

### 데이터 보존
- RTC 설정값을 플래시 메모리(섹터 7)에 저장
- 전원 재투입 시 자동 복원
- DS1302용 BCD ↔ DEC 변환

## 🔍 문제 해결

- **모터가 움직이지 않음**: 스텝모터 연결 확인 (PC6-PC9)
- **층 감지 문제**: 포토센서 배선 확인 (PB0-PB3)
- **디스플레이 없음**: SPI/I2C 연결 확인
- **소리 없음**: 부저 연결 확인 (PA6)

## 📱 데모 영상

프로젝트 실행 모습:
- 버튼 입력 → 층 선택음
- 모터 동작 → 방향 표시
- 층 도착 → 도착음 + 층수 표시

## 🔧 확장 가능성

- **층수 확장**: 8층까지 확장 가능
- **안전 기능**: 문 센서, 비상정지 추가
- **네트워크**: WiFi/Bluetooth 모듈 연동
- **GUI**: 터치스크린 인터페이스

## 📄 라이선스

MIT 라이선스 - 교육 목적으로 자유롭게 사용 가능합니다.

## 🤝 기여하기

1. 저장소 포크
2. 기능 브랜치 생성
3. 변경사항 커밋
4. 브랜치에 푸시
5. 풀 리퀘스트 생성
